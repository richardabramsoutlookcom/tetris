---
phase: 02-gameboy-music
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tetris-app/src/constants/melodies.js
  - tetris-app/src/hooks/useMusic.js
autonomous: true

must_haves:
  truths:
    - "Type A melody plays as recognizable Korobeiniki tune"
    - "Type B melody plays as distinct second track"
    - "Type C melody plays as distinct third track"
    - "All melodies loop continuously"
    - "Music can be started, stopped, and paused programmatically"
  artifacts:
    - path: "tetris-app/src/constants/melodies.js"
      provides: "Note data for all three Gameboy Tetris tracks"
      exports: ["MELODY_TYPE_A", "MELODY_TYPE_B", "MELODY_TYPE_C"]
    - path: "tetris-app/src/hooks/useMusic.js"
      provides: "Music playback engine with track selection"
      exports: ["useMusic"]
  key_links:
    - from: "useMusic.js"
      to: "melodies.js"
      via: "import and playback scheduling"
      pattern: "import.*melodies"
    - from: "useMusic.js"
      to: "Web Audio API"
      via: "AudioContext scheduling"
      pattern: "AudioContext|createOscillator"
---

<objective>
Create music engine and melody data for Gameboy Tetris soundtracks.

Purpose: Enable authentic 8-bit music playback during gameplay with three selectable tracks (Type A/Korobeiniki, Type B, Type C).
Output: useMusic hook with play/pause/stop/setTrack API, melody constants for all three tracks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tetris-app/src/hooks/useSound.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create melody constants</name>
  <files>tetris-app/src/constants/melodies.js</files>
  <action>
Create melodies.js with note data for all three Gameboy Tetris tracks.

Each melody is an array of note objects: { note, duration, rest? }
- note: frequency in Hz (use standard note frequencies)
- duration: note length in ms
- rest: optional silence after note in ms

MELODY_TYPE_A (Korobeiniki - the famous Tetris theme):
Main motif in E minor. Key notes:
E5-B4-C5-D5-C5-B4-A4-A4-C5-E5-D5-C5-B4-C5-D5-E5-C5-A4-A4
Use tempo ~120 BPM (500ms per beat). Mix quarter and eighth notes.

MELODY_TYPE_B:
Different melody, still 8-bit feel. Simpler pattern, more staccato.
Use a march-like rhythm in C major.

MELODY_TYPE_C:
Third distinct track. Gentle/flowing feel.
Use legato quarter notes, F major scale passages.

Each melody should be 4-8 bars that loop seamlessly.

Export: MELODY_TYPE_A, MELODY_TYPE_B, MELODY_TYPE_C, TRACK_NAMES (for UI)

Note frequency reference:
C4=262, D4=294, E4=330, F4=349, G4=392, A4=440, B4=494
C5=523, D5=587, E5=659, F5=698, G5=784, A5=880, B5=988
  </action>
  <verify>File exists with three melody exports, each is non-empty array</verify>
  <done>Three distinct melodies defined with proper note/duration data</done>
</task>

<task type="auto">
  <name>Task 2: Create useMusic hook</name>
  <files>tetris-app/src/hooks/useMusic.js</files>
  <action>
Create useMusic hook following useSound.js pattern but for continuous music playback.

MusicEngine class (similar to SoundEngine):
- Uses AudioContext with master gain
- playNote(frequency, duration): plays single note with 8-bit square wave character
- scheduleNote(note, startTime): schedules note at specific audioContext time
- playMelody(melodyData): schedules all notes, loops when done
- Uses lookahead scheduling pattern: schedule notes ~100ms ahead, use setInterval to keep refilling

Hook API (useMusic):
- currentTrack: null | 'A' | 'B' | 'C'
- isPlaying: boolean
- setTrack(track): change track (null to disable)
- play(): start/resume current track
- pause(): pause playback (remember position for resume)
- stop(): stop and reset to beginning
- volume: 0-1 (default 0.2, lower than SFX)

Key implementation details:
- Use requestAnimationFrame or setInterval for scheduling loop
- Store scheduledNotes array to cancel on stop/pause
- Lookahead pattern: calculate next notes to schedule, schedule them, move forward
- When melody ends, restart from beginning (loop)
- Use square wave oscillator for 8-bit sound
- Shorter attack/decay for crisp Gameboy feel (attack ~0.01, decay ~0.05)

DO NOT integrate with game state yet - that's plan 02.
  </action>
  <verify>Hook exports useMusic function, can be imported without errors</verify>
  <done>useMusic hook provides play/pause/stop/setTrack API with looping melody playback</done>
</task>

<task type="auto">
  <name>Task 3: Add basic music persistence</name>
  <files>tetris-app/src/hooks/useMusic.js</files>
  <action>
Extend useMusic to persist track selection to localStorage.

- Key: 'tetris-music-track'
- On init: read saved track preference (default: 'A')
- On setTrack: save to localStorage
- Follow useKeyBindings.js pattern for try-catch error handling

This ensures user's music preference persists across sessions.
  </action>
  <verify>Change track, refresh page, track preference should be remembered</verify>
  <done>Music track selection persists via localStorage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` shows no new errors in created files
- [ ] melodies.js exports three melody arrays
- [ ] useMusic.js exports useMusic hook
- [ ] Hook can be instantiated (test in isolation or via console)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Music engine foundation ready for UI integration
- Three distinct melodies defined and playable
</success_criteria>

<output>
After completion, create `.planning/phases/02-gameboy-music/02-01-SUMMARY.md`
</output>
